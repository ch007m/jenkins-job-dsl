apply plugin: 'groovy'

version = '1.0.0-SNAPSHOT'

sourceSets {
    jobs {
        groovy {
            srcDirs 'jobs'
            compileClasspath += main.compileClasspath
        }
        compileClasspath += sourceSets.main.output
        runtimeClasspath += sourceSets.main.output
    }
}

//create a single Jar with all dependencies
task fatJar(type: Jar) {
    manifest {
        attributes 'Implementation-Title': 'Gradle Jar File',
                'Implementation-Version': version,
                'Main-Class': 'dev.snowdrop.FilePathHelper'
    }
    baseName = project.name + '-all'
    from { configurations.compile.collect { it.isDirectory() ? it : zipTree(it) } }
    with jar
}

repositories {
    maven {
        url 'https://repo.jenkins-ci.org/public/'
    }
}

configurations {
    testPlugins {}
}

dependencies {
    compile "org.jenkins-ci.main:jenkins-core:${jenkinsCore}"
    compile "org.jenkins-ci.main:remoting:${jenkinsRemoting}"
    compile "org.jenkins-ci.plugins:groovy:${jenkinsGroovyPlugin}@jar"
    compile "javax.servlet:javax.servlet-api:3.1.0"
    compile("org.jenkins-ci.plugins:job-dsl-core:1.77@jar")

    testCompile("org.jenkins-ci.main:jenkins-test-harness:${jenkinsTestHarness}")
    testCompile("org.jenkins-ci.main:jenkins-war:${jenkinsCore}")

    testCompile("org.jenkins-ci.plugins:job-dsl:1.77")
    testCompile("org.jenkins-ci.plugins:job-dsl:1.77@jar")


    // List of jar calculated from the plugins list using jenkins UI 2.271
/*    testCompile 'io.jenkins.plugins:okhttp-api:3.14.9@jar'
    testCompile 'io.jenkins.plugins:snakeyaml-api:1.26.3@jar'
    testCompile 'org.6wind.jenkins:lockable-resources:2.10@jar'
    testCompile 'org.jenkins-ci.plugins.pipeline-stage-view:pipeline-rest-api:2.19@jar'
    testCompile 'org.jenkins-ci.plugins.pipeline-stage-view:pipeline-stage-view:2.19@jar'
    testCompile 'org.jenkins-ci.plugins.workflow:workflow-aggregator:2.6@jar'
    testCompile 'org.jenkins-ci.plugins.workflow:workflow-api:2.40@jar'
    testCompile 'org.jenkins-ci.plugins.workflow:workflow-basic-steps:2.21@jar'
    testCompile 'org.jenkins-ci.plugins.workflow:workflow-cps-global-lib:2.17@jar'
    testCompile 'org.jenkins-ci.plugins.workflow:workflow-cps:2.87@jar'
    testCompile 'org.jenkins-ci.plugins.workflow:workflow-durable-task-step:2.35@jar'
    testCompile 'org.jenkins-ci.plugins.workflow:workflow-job:2.40@jar'
    testCompile 'org.jenkins-ci.plugins.workflow:workflow-multibranch:2.22@jar'
    testCompile 'org.jenkins-ci.plugins.workflow:workflow-scm-step:2.11@jar'
    testCompile 'org.jenkins-ci.plugins.workflow:workflow-step-api:2.23@jar'
    testCompile 'org.jenkins-ci.plugins.workflow:workflow-support:3.7@jar'
    testCompile 'org.jenkins-ci.plugins:ant:1.11@jar'
    testCompile 'org.jenkins-ci.plugins:antisamy-markup-formatter:2.1@jar'
    testCompile 'org.jenkins-ci.plugins:apache-httpcomponents-client-4-api:4.5.10-2.0@jar'
    testCompile 'org.jenkins-ci.plugins:bouncycastle-api:2.18@jar'
    testCompile 'org.jenkins-ci.plugins:branch-api:2.6.2@jar'
    testCompile 'org.jenkins-ci.plugins:build-timeout:1.19.1@jar'
    testCompile 'org.jenkins-ci.plugins:cloudbees-folder:6.14@jar'
    testCompile 'org.jenkins-ci.plugins:command-launcher:1.2@jar'
    testCompile 'org.jenkins-ci.plugins:credentials-binding:1.24@jar'
    testCompile 'org.jenkins-ci.plugins:credentials:2.3.11@jar'
    testCompile 'org.jenkins-ci.plugins:display-url-api:2.3.4@jar'
    testCompile 'org.jenkins-ci.plugins:durable-task:1.35@jar'
    testCompile 'org.jenkins-ci.plugins:email-ext:2.80@jar'
    testCompile 'org.jenkins-ci.plugins:git-client:3.2.1@jar'
    testCompile 'org.jenkins-ci.plugins:git-server:1.9@jar'
    testCompile 'org.jenkins-ci.plugins:git:4.2.2@jar'
    testCompile 'org.jenkins-ci.plugins:github-api:1.117@jar'
    testCompile 'org.jenkins-ci.plugins:github-branch-source:2.9.2@jar'
    testCompile 'org.jenkins-ci.plugins:gradle:1.36@jar'
    testCompile 'org.jenkins-ci.plugins:jackson2-api:2.11.1@jar'
    testCompile 'org.jenkins-ci.plugins:jdk-tool:1.0@jar'
    testCompile 'org.jenkins-ci.plugins:jsch:0.1.55.2@jar'
    testCompile 'org.jenkins-ci.plugins:junit:1.29@jar'
    testCompile 'org.jenkins-ci.plugins:ldap:1.26@jar'
    testCompile 'org.jenkins-ci.plugins:mailer:1.32.1@jar'
    testCompile 'org.jenkins-ci.plugins:mapdb-api:1.0.9.0@jar'
    testCompile 'org.jenkins-ci.plugins:matrix-auth:2.6.4@jar'
    testCompile 'org.jenkins-ci.plugins:matrix-project:1.18@jar'
    testCompile 'org.jenkins-ci.plugins:pam-auth:1.6@jar'
    testCompile 'org.jenkins-ci.plugins:pipeline-build-step:2.13@jar'
    testCompile 'org.jenkins-ci.plugins:pipeline-github-lib:1.0@jar'
    testCompile 'org.jenkins-ci.plugins:pipeline-graph-analysis:1.10@jar'
    testCompile 'org.jenkins-ci.plugins:pipeline-input-step:2.12@jar'
    testCompile 'org.jenkins-ci.plugins:pipeline-milestone-step:1.3.1@jar'
    testCompile 'org.jenkins-ci.plugins:pipeline-stage-step:2.5@jar'
    testCompile 'org.jenkins-ci.plugins:plain-credentials:1.7@jar'
    testCompile 'org.jenkins-ci.plugins:resource-disposer:0.14@jar'
    testCompile 'org.jenkins-ci.plugins:scm-api:2.6.4@jar'
    testCompile 'org.jenkins-ci.plugins:script-security:1.75@jar'
    testCompile 'org.jenkins-ci.plugins:ssh-credentials:1.18.1@jar'
    testCompile 'org.jenkins-ci.plugins:ssh-slaves:1.31.2@jar'
    testCompile 'org.jenkins-ci.plugins:subversion:2.13.2@jar'
    testCompile 'org.jenkins-ci.plugins:timestamper:1.11.6@jar'
    testCompile 'org.jenkins-ci.plugins:token-macro:2.12@jar'
    testCompile 'org.jenkins-ci.plugins:trilead-api:1.0.10@jar'
    testCompile 'org.jenkins-ci.plugins:ws-cleanup:0.38@jar'
    testCompile 'org.jenkins-ci.ui:ace-editor:1.1@jar'
    testCompile 'org.jenkins-ci.ui:handlebars:1.1.1@jar'
    testCompile 'org.jenkins-ci.ui:momentjs:1.1.1@jar'
    testCompile 'org.jenkinsci.plugins:pipeline-model-api:1.7.2@jar'
    testCompile 'org.jenkinsci.plugins:pipeline-model-definition:1.7.2@jar'
    testCompile 'org.jenkinsci.plugins:pipeline-model-extensions:1.7.2@jar'
    testCompile 'org.jenkinsci.plugins:pipeline-stage-tags-metadata:1.7.2@jar'*/

    // Plugins added post plugin list calculation and needed by the Junit test case
    testCompile 'com.coravy.hudson.plugins.github:github:1.32.0@jar'
    testCompile 'org.jenkins-ci.plugins:structs:1.20@jar'
    testCompile 'org.eclipse.jgit:org.eclipse.jgit:5.10.0.202012080955-r'

    testCompile 'org.jenkins-ci.main:maven-plugin:3.8@jar'
    testCompile 'org.jenkins-ci.main:maven-plugin:3.8'

    testCompile 'org.spockframework:spock-core:1.3-groovy-2.4'

    // Plugins list installed from the suggested plugins proposed when we configure a local jenkins instance
    testPlugins 'com.coravy.hudson.plugins.github:github:1.32.0'
    testPlugins 'io.jenkins.plugins:bootstrap4-api:4.5.3-1'
    testPlugins 'io.jenkins.plugins:checks-api:1.1.1'
    testPlugins 'io.jenkins.plugins:echarts-api:4.9.0-2'
    testPlugins 'io.jenkins.plugins:font-awesome-api:5.15.1-1'
    testPlugins 'io.jenkins.plugins:jaxb:2.3.0.1'
    testPlugins 'io.jenkins.plugins:jquery3-api:3.5.1-2'
    testPlugins 'io.jenkins.plugins:okhttp-api:3.14.9'
    testPlugins 'io.jenkins.plugins:plugin-util-api:1.6.0'
    testPlugins 'io.jenkins.plugins:popper-api:1.16.0-7'
    testPlugins 'io.jenkins.plugins:snakeyaml-api:1.27.0'
    testPlugins 'org.6wind.jenkins:lockable-resources:2.10'
    testPlugins 'org.jenkins-ci.plugins.pipeline-stage-view:pipeline-rest-api:2.19'
    testPlugins 'org.jenkins-ci.plugins.pipeline-stage-view:pipeline-stage-view:2.19'
    testPlugins 'org.jenkins-ci.plugins.workflow:workflow-aggregator:2.6'
    testPlugins 'org.jenkins-ci.plugins.workflow:workflow-api:2.40'
    testPlugins 'org.jenkins-ci.plugins.workflow:workflow-basic-steps:2.23'
    testPlugins 'org.jenkins-ci.plugins.workflow:workflow-cps-global-lib:2.17'
    testPlugins 'org.jenkins-ci.plugins.workflow:workflow-cps:2.87'
    testPlugins 'org.jenkins-ci.plugins.workflow:workflow-durable-task-step:2.37'
    testPlugins 'org.jenkins-ci.plugins.workflow:workflow-job:2.40'
    testPlugins 'org.jenkins-ci.plugins.workflow:workflow-multibranch:2.22'
    testPlugins 'org.jenkins-ci.plugins.workflow:workflow-scm-step:2.11'
    testPlugins 'org.jenkins-ci.plugins.workflow:workflow-step-api:2.23'
    testPlugins 'org.jenkins-ci.plugins.workflow:workflow-support:3.7'
    testPlugins 'org.jenkins-ci.plugins:ant:1.11'
    testPlugins 'org.jenkins-ci.plugins:antisamy-markup-formatter:2.1'
    testPlugins 'org.jenkins-ci.plugins:apache-httpcomponents-client-4-api:4.5.10-2.0'
    testPlugins 'org.jenkins-ci.plugins:bouncycastle-api:2.18'
    testPlugins 'org.jenkins-ci.plugins:branch-api:2.6.3'
    testPlugins 'org.jenkins-ci.plugins:build-timeout:1.20'
    testPlugins 'org.jenkins-ci.plugins:cloudbees-folder:6.15'
    testPlugins 'org.jenkins-ci.plugins:command-launcher:1.5'
    testPlugins 'org.jenkins-ci.plugins:credentials-binding:1.24'
    testPlugins 'org.jenkins-ci.plugins:credentials:2.3.14'
    testPlugins 'org.jenkins-ci.plugins:display-url-api:2.3.4'
    testPlugins 'org.jenkins-ci.plugins:durable-task:1.35'
    testPlugins 'org.jenkins-ci.plugins:email-ext:2.80'
    testPlugins 'org.jenkins-ci.plugins:git-client:3.5.1'
    testPlugins 'org.jenkins-ci.plugins:git-server:1.9'
    testPlugins 'org.jenkins-ci.plugins:git:4.5.0'
    testPlugins 'org.jenkins-ci.plugins:github-api:1.117'
    testPlugins 'org.jenkins-ci.plugins:github-branch-source:2.9.2'
    testPlugins 'org.jenkins-ci.plugins:gradle:1.36'
    testPlugins 'org.jenkins-ci.plugins:jackson2-api:2.12.0'
    testPlugins 'org.jenkins-ci.plugins:jdk-tool:1.4'
    testPlugins 'org.jenkins-ci.plugins:jsch:0.1.55.2'
    testPlugins 'org.jenkins-ci.plugins:junit:1.47'
    testPlugins 'org.jenkins-ci.plugins:ldap:2.2'
    testPlugins 'org.jenkins-ci.plugins:mailer:1.32.1'
    testPlugins 'org.jenkins-ci.plugins:matrix-auth:2.6.4'
    testPlugins 'org.jenkins-ci.plugins:matrix-project:1.18'
    testPlugins 'org.jenkins-ci.plugins:pam-auth:1.6'
    testPlugins 'org.jenkins-ci.plugins:pipeline-build-step:2.13'
    testPlugins 'org.jenkins-ci.plugins:pipeline-github-lib:1.0'
    testPlugins 'org.jenkins-ci.plugins:pipeline-graph-analysis:1.10'
    testPlugins 'org.jenkins-ci.plugins:pipeline-input-step:2.12'
    testPlugins 'org.jenkins-ci.plugins:pipeline-milestone-step:1.3.1'
    testPlugins 'org.jenkins-ci.plugins:pipeline-stage-step:2.5'
    testPlugins 'org.jenkins-ci.plugins:plain-credentials:1.7'
    testPlugins 'org.jenkins-ci.plugins:resource-disposer:0.14'
    testPlugins 'org.jenkins-ci.plugins:scm-api:2.6.4'
    testPlugins 'org.jenkins-ci.plugins:script-security:1.75'
    testPlugins 'org.jenkins-ci.plugins:ssh-credentials:1.18.1'
    testPlugins 'org.jenkins-ci.plugins:ssh-slaves:1.31.4'
    testPlugins 'org.jenkins-ci.plugins:timestamper:1.11.8'
    testPlugins 'org.jenkins-ci.plugins:token-macro:2.12'
    testPlugins 'org.jenkins-ci.plugins:trilead-api:1.0.13'
    testPlugins 'org.jenkins-ci.plugins:ws-cleanup:0.38'
    testPlugins 'org.jenkins-ci.ui:ace-editor:1.1'
    testPlugins 'org.jenkins-ci.ui:handlebars:1.1.1'
    testPlugins 'org.jenkins-ci.ui:momentjs:1.1.1'
    testPlugins 'org.jenkinsci.plugins:pipeline-model-api:1.7.2'
    testPlugins 'org.jenkinsci.plugins:pipeline-model-definition:1.7.2'
    testPlugins 'org.jenkinsci.plugins:pipeline-model-extensions:1.7.2'
    testPlugins 'org.jenkinsci.plugins:pipeline-stage-tags-metadata:1.7.2'

    // Plugins missing and not installed with list suggested when we configure a local jenkins instance
    testPlugins 'org.jenkins-ci.main:maven-plugin:3.8'
    testPlugins 'org.jenkins-ci.plugins:structs:1.20'
    testPlugins 'org.jenkins-ci.tools:git-parameter:0.9.13'

    // Run the following script in the Script Console of your Jenkins instance to generate
    // the above testPlugins list. (adapted from https://git.io/fjpUs)
    /*
        Jenkins.instance.pluginManager.plugins
            .findAll { !(it.shortName in ['job-dsl', 'structs']) }
            .collect { "testPlugins '${it.manifest.mainAttributes.getValue("Group-Id")}:${it.shortName}:${it.version}'" }
            .sort()
            .each { println it }

        and testCompile dependencies
        Jenkins.instance.pluginManager.plugins
            .findAll { !(it.shortName in ['job-dsl', 'structs']) }
            .collect { "testCompile '${it.manifest.mainAttributes.getValue("Group-Id")}:${it.shortName}:${it.version}@jar'" }
            .sort()
            .each { println it }
     */
}

task resolveTestPlugins(type: Copy) {
    from configurations.testPlugins
    into new File(sourceSets.test.output.resourcesDir, 'test-dependencies')
    include '*.hpi'
    include '*.jpi'
    def mapping = [:]

    doFirst {
        configurations.testPlugins.resolvedConfiguration.resolvedArtifacts.each {
            mapping[it.file.name] = "${it.name}.${it.extension}"
        }
    }
    rename { mapping[it] }

    doLast {
        List<String> baseNames = source*.name.collect { mapping[it] }.collect { it[0..it.lastIndexOf('.') - 1] }
        new File(destinationDir, 'index').setText(baseNames.join('\n'), 'UTF-8')
    }
}

test {
    dependsOn tasks.resolveTestPlugins
    inputs.files sourceSets.jobs.groovy.srcDirs
}